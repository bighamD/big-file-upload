/**
 * PDA_SDK 1.1.0
 * Copyright 2017-2020
 * Released on: 2020-08-27 16:21:47
 */
"use strict";var tool={wxPromisify:function(n){return function(e){return void 0===e&&(e={}),new Promise(function(t,a){e.success=function(e){t(e)},e.fail=function(e){a(e)},n(e)})}},changeParameter:function(e,t,a){a=a||this.getCurrentPage();var n=e+"=([^&]*)",o=e+"="+encodeURIComponent(t),i=-1===a.indexOf("#")?a.length:a.indexOf("#"),r=a.substring(i),s=a.substring(0,i);if(s.match(n)){var c=new RegExp("("+e+"=)([^&]*)","ig");return s.replace(c,o)+r}return s.match("[?]")?s+"&"+o+r:s+"?"+o+r},queryStringToJSON:function(e){void 0===e&&(e="");var t=e.split("&"),a={};return t.forEach(function(e){e=e.split("="),a[e[0]]=e[1]||""}),a},parseData:function(e){var t="";if("object"==typeof e)for(var a in e)"object"==typeof e[a]?t+=parseData(e[a]):e[a]&&(t+=a+"="+e[a]+"&");return t=t.replace(/(&$)/g,"")},pdaParamObjFormat:function(n,o){var i=this;void 0===n&&(n={}),void 0===o&&(o={});var r={},e=[["innerid"],["source","outersource"],["outerid","cid"],["productid"]],t=[].concat.apply([],e),a=this.omit(o,t),s=this.omit(n,t);return e.forEach(function(e){var t=i.pick(n,e),a=Object.keys(t).length?t:i.pick(o,e);Object.assign(r,a)}),Object.assign(r,a,s),r},omit:function(e,t){void 0===e&&(e={}),void 0===t&&(t=[]);var a=Object.keys(e).filter(function(e){return-1===t.indexOf(e)});return this.pick(e,a)},pick:function(e,n){void 0===e&&(e={}),void 0===n&&(n=[]);function a(t,a){void 0===t&&(t={}),void 0===a&&(a={}),n.forEach(function(e){t[e]&&(a[e]=t[e])})}var t=Array.isArray(e),o=t?[]:{};return t?e.forEach(function(e,t){o.push({}),a(e,o[t])}):a(e,o),o},getCurrentPage:function(){var e=getCurrentPages();return 0<e.length?e[e.length-1].route:""},deepCopy:function(e){if(e instanceof Array){for(var t=[],a=0;a<e.length;++a)t[a]=this.deepCopy(e[a]);return t}if(e instanceof Function)return new Function("return "+e.toString())();if(e instanceof Object){var n={};for(var o in e)n[o]=this.deepCopy(e[o]);return n}return e},deepResolve:function(e,t){if(e instanceof Object){if(e[t])return encodeURIComponent(e[t]);for(var a in e){var n;if(n=this.deepResolve(e[a],t))return n}return""}return""}},config={api:{app:"https://rsb-stg.pingan.com.cn/brcp/log/cust/behavior/weixin/app.do",code2Session:"https://rsb-stg.pingan.com.cn/consume/bron/cust/crss_biz/crss/weixin/platform/code2Session"},constants:{env:"stg"}},nameSpace="pda_"+config.constants.env,storage={setStorage:function(e,t){wx.setStorageSync(nameSpace+"_"+e,t)},getStorage:function(e){return wx.getStorageSync(nameSpace+"_"+e)}},SDK_CONF=require("./PDA_SDK.conf.js"),wxPromisify=tool.wxPromisify,SDKVersion="1.0.3",MAX_SEND_PDA_LEN=10,MAX_SEND_PDA_TIME=1e4,SESSION_ID=createRandomHex(),request_index=1,pda_data={geo:{lat:"",lng:""},systemInfo:{model:"",brand:"",WXVersion:"",os:"",osVersion:"",WXSDKVersion:"",system:"",platform:""},sessionid:SESSION_ID,SDKVersion:SDKVersion,networkType:"",paramObj:SDK_CONF.param,appInfo:SDK_CONF.app,storageParam:{brcpsessionticket:getTicket(),deviceId:""},scene:"",unionid:"",openid:""},timePoint="";function getWxScope(){return wxPromisify(wx.getSetting)().then(function(e){var t=[];return e.authSetting["scope.userLocation"]&&t.push(wxPromisify(wx.getLocation)()),e.authSetting["scope.userInfo"]?t.push(wxPromisify(wx.getUserInfo)()):t.push(Promise.resolve({errMsg:"getUserInfo:ok"})),t.push(wxPromisify(wx.getSystemInfo)()),t.push(wxPromisify(wx.getNetworkType)()),Promise.all(t)})}function setPdaDate(e){return e.forEach(function(e){switch(e.errMsg){case"getLocation:ok":pda_data.geo.lat=e.latitude,pda_data.geo.lng=e.longitude;break;case"getSystemInfo:ok":pickParam(e,"systemInfo"),pda_data.systemInfo.WXVersion=e.version,pda_data.systemInfo.os=e.system.split(" ")[0],pda_data.systemInfo.osVersion=e.system.split(" ")[1],pda_data.systemInfo.WXSDKVersion=e.SDKVersion;break;case"getNetworkType:ok":pda_data.networkType=e.networkType}}),e.filter(function(e){return-1!=e.errMsg.indexOf("getUserInfo")})[0]}function code2Session(e){return wxPromisify(wx.request)({url:config.api.code2Session,data:e,method:"POST"})}function pickParam(t,e){var a=pda_data[e];Object.keys(a).forEach(function(e){a[e]=t[e]||""})}function createDeviceID(){var e=storage.getStorage("deviceId");if(e)pda_data.storageParam.deviceId=e;else{var t=createRandomHex();storage.setStorage("deviceId",t),pda_data.storageParam.deviceId=t}}function createRandomHex(){for(var e="",t=(new Date).getTime().toString(),a=2;a<=32-t.length;a++)e+=Math.floor(16*Math.random()).toString(16);return e+t}function updateTicket(e){storage.setStorage("brcpsessionticket",e),pda_data.storageParam.brcpsessionticket=e}function getTicket(){return storage.getStorage("brcpsessionticket")||""}function setCache(e){for(var t=storage.getStorage("pdaDataCache")||[],a=tool.getCurrentPage(),n="",o="",i="",r=SDK_CONF.app.pageList,s=0;s<r.length;s++)if(r[s].url===a){n=r[s].name,o=r[s].pageID,i=r[s].activity_FlowId||"";break}e.eventParam.activity_FlowId=i,e.eventParam.pageUrl=a,e.eventParam.pageTitle=n,e.eventParam.pageID=o,pda_data.unionid=e.paramObj.unionid?e.paramObj.unionid:pda_data.unionid,pda_data.openid=e.paramObj.openid?e.paramObj.openid:pda_data.openid;var c={paramObj:e.paramObj,eventParam:e.eventParam};t.push(c),storage.setStorage("pdaDataCache",t)}function getCache(){return storage.getStorage("pdaDataCache")||[]}function clearCache(e){var t=getCache();if(e=parseInt(e),!isNaN(e)){var a=t.slice(e);storage.setStorage("pdaDataCache",a)}}function sendCache(){var e=getCache();if(0!=e.length){var t=e.slice(0,MAX_SEND_PDA_LEN);stopTimeOut(),void 0,wxPromisify(wx.request)({url:config.api.app,data:{uploadInfo:pdaDataFormat(t)},method:"POST"}).then(function(e){e.data&&"200"==e.data.code?(void 0,clearCache(MAX_SEND_PDA_LEN)):void 0,startTimeOut()}).catch(function(e){startTimeOut(),void 0})}else startTimeOut()}function startTimeOut(){timePoint&&clearTimeout(timePoint),timePoint=setTimeout(function(){sendCache()},MAX_SEND_PDA_TIME)}function stopTimeOut(){timePoint&&clearTimeout(timePoint)}function pdaDataFormat(e){if(void 0===e&&(e=[]),0!=e.length){var a=["Version","head_element_num","body_element_num","body_line_num"],n=["sessionid","deviceId","brand","model","WXVersion","os","osVersion","WXSDKVersion","SDKVersion","networkType","lat","lng","appid","appName","appVersion","brcpsessionticket","scene","unionid","openid","nickname","headimgurl"],o=["index","timestamp","pageUrl","pageTitle","olabel","otitle","source","outersource","outerid","cid","innerid","param","pageID","infoType","last_time","duration","activity_FlowId","productid"],t=["param1","param2","param3","param4","param5","param6","param7","param8","param9","param10"];a=a.concat(t),n=n.concat(t.slice(5,10)),o=o.concat(t.slice(6,10));var i="",r="",s="",c={Version:"1.0.1",head_element_num:n.length,body_element_num:o.length,body_line_num:e.length};return a.forEach(function(e,t){i+=tool.deepResolve(c,e)+(t===a.length-1?"@n":"|")}),n.forEach(function(e,t){t===n.length-1?r+=tool.deepResolve(pda_data,e)+"@n":r+=tool.deepResolve(pda_data,e)+"|"}),e.forEach(function(a){o.forEach(function(e,t){t===o.length-1?s+=tool.deepResolve(a,e)+"@n":s+=tool.deepResolve(a,e)+"|"})}),i+r+s}}function wxLogin(){return new Promise(function(t,a){wx.login({success:function(e){e.code?t(e):a()}})})}function setCodeData(e){storage.setStorage("code2SessionData",e),setunionidData(e)}function setunionidData(e){void 0===e&&(e={}),pda_data.unionid=e.unionid,pda_data.openid=e.openid}function setInfoData(e){storage.setStorage("usrInfoDate",e),setusrInfoDate(e)}function setusrInfoDate(e){void 0===e&&(e={}),pda_data.nickname=e.nickName,pda_data.headimgurl=e.avatarUrl}function init(){createDeviceID(),storage.setStorage("sessionId",SESSION_ID);var a={appid:SDK_CONF.app.appid,code:""},e=storage.getStorage("code2SessionData")||{},t=storage.getStorage("usrInfoDate")||{};e.unionid&&t.nickName?(setunionidData(e),setusrInfoDate(t),getWxScope().then(setPdaDate).then(sendCache)):wxLogin().then(function(e){if(!e.code)return void 0,Promise.reject();a.code=e.code}).then(getWxScope).then(setPdaDate).then(function(e){if((e=e||{}).userInfo){var t={};t.nickName=e.userInfo.nickName,t.avatarUrl=e.userInfo.avatarUrl,setInfoData(t)}e.iv&&(a.iv=e.iv),e.encryptedData&&(a.encryptedData=e.encryptedData)}).then(function(e){return code2Session(a)}).then(function(e){try{setCodeData(e.data&&e.data.data||{})}catch(e){setCodeData({})}}).then(sendCache).catch(function(e){getWxScope().then(setPdaDate).then(sendCache)})}init();var startTime,endTime,PDA_SDK={setPageConfig:function(e){void 0===e&&(e={});for(var t=tool.getCurrentPage(),a=SDK_CONF.app.pageList,n=0;n<a.length;n++)if(a[n].url===t&&e.activity_FlowId){a[n].activity_FlowId=e.activity_FlowId;break}var o={pageList:a};pickParam(tool.pdaParamObjFormat(o,pda_data.appInfo),"appInfo")},setConfig:function(e){void 0===e&&(e={}),pickParam(tool.pdaParamObjFormat(e,pda_data.paramObj),"paramObj"),"brcpsessionticket"in e&&updateTicket(e.brcpsessionticket)},trackEvent:function(e){var t=tool.deepCopy(pda_data);"7"===e.infoType?t.eventParam={index:request_index,timestamp:(new Date).getTime(),infoType:e.infoType,last_time:e.last_time||"",duration:e.duration||"",otitle:JSON.stringify(e.otitle),olabel:e.olabel,param:e.param?JSON.stringify(e.param):""}:t.eventParam={index:request_index,timestamp:(new Date).getTime(),infoType:e.infoType||"5",last_time:e.last_time||"",duration:e.duration||"",otitle:e.otitle,olabel:e.olabel||e.otitle,param:e.param?JSON.stringify(e.param):""},request_index++,setCache(t)},getMainParam:function(){return pda_data.paramObj},addUrlPdaParam:function(e,t){var a="";if(!e)return a=tool.parseData(pda_data.paramObj);var n=e.split("#")[1],o=e.split("?")[1];o=o?o.split("#")[0]:o;var i=tool.queryStringToJSON(o),r=tool.pdaParamObjFormat(i,pda_data.paramObj);"onShareAppMessage"===t&&delete r.innerid,a=tool.parseData(r);var s=n?"#"+n:-1<e.indexOf("#")?"#":"";return e.split("?")[0].split("#")[0]+"?"+a+s},setScene:function(e){pda_data.scene=e.scene}},config$1=require("./PDA_SDK.conf.js"),sourceApp=App,sourcePage=Page;function init$1(){rewrite()}function proxy(e,a,n){void 0===e&&(e={}),void 0===a&&(a=""),void 0===n&&(n=function(){});var o=e[a];e[a]=function(e){if("onShareAppMessage"===a){var t="function"==typeof o?o.call(this,e):{};return t.path=t.path||config$1.app.defaultSharePage||tool.getCurrentPage(),t.path=PDA_SDK.addUrlPdaParam(t.path,"onShareAppMessage"),PDA_SDK.trackEvent({otitle:"小程序分享",infoType:"18"}),t}o&&o.call(this,e),n.call(this,e)}}function rewrite(){App=function(t){var a={onLaunch:function(e){void 0,PDA_SDK.setScene(e),startTime=(new Date).getTime()},onShow:function(e){PDA_SDK.setScene(e),void 0,startTime=(new Date).getTime(),PDA_SDK.trackEvent({otitle:"小程序打开",infoType:"12"}),void 0,void 0,e&&e.query&&PDA_SDK.setConfig(e.query)},onHide:function(e){void 0,endTime=(new Date).getTime(),PDA_SDK.trackEvent({otitle:"小程序关闭",infoType:"13"}),void 0,void 0}};Object.keys(a).forEach(function(e){proxy(t,e,a[e])}),t.PDA_SDK=PDA_SDK,sourceApp(t)},Page=function(t){var a={onShow:function(){void 0,startTime=(new Date).getTime(),void 0,PDA_SDK.trackEvent({otitle:"页面展示",infoType:"10"})},onHide:function(){void 0,endTime=(new Date).getTime(),PDA_SDK.trackEvent({infoType:"8",last_time:startTime,duration:endTime-startTime})},onUnload:function(){endTime=(new Date).getTime(),PDA_SDK.trackEvent({infoType:"8",last_time:startTime,duration:endTime-startTime})},onShareAppMessage:function(){}};Object.keys(a).forEach(function(e){proxy(t,e,a[e])}),sourcePage(t)}}init$1();var index={};module.exports=index;